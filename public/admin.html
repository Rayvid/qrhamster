<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin panel</title>

    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.4/build/global/luxon.min.js"></script>
    <script src="js/star.js"></script>

    <link rel="stylesheet" href="css/admin.css" />
    <style>
      body {
        background: #f5f5f9;
        color: rgba(0, 0, 0, 0.87);
        font-family: Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 0;
      }
    </style>

    <script type="text/javascript">
      const config = {
        apiKey: "AIzaSyBe6QaZqUU5UNK8SdE3QAnQwFv6pXCpldw",
        authDomain: "qrhamsters-app.firebaseapp.com",
        projectId: "qrhamsters-app",
        storageBucket: "qrhamsters-app.appspot.com",
        messagingSenderId: "948754742478",
        appId: "1:948754742478:web:33526dfa79f6414c32e49f",
      };
      firebase.initializeApp(config);
    </script>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="header">Event attendees</div>
        <table class="attendees">
          <div id="loader"></div>
        </table>
      </div>
    </div>
    <script type="text/javascript">
      const DateTime = luxon.DateTime;
      const sections = [
        "Keynote",
        "Lunch",
        'Workshop "Legal"',
        "Lounge area",
        "Afterparty",
      ];

      function formatTimestamp(timestamp){
        return DateTime.fromSeconds(timestamp).toFormat('yyyy-MM-dd HH:mm:ss')
      }
      function field(name,value,classname=""){
        return `
          <div class="field ${classname}">
            <div class="name">${name}</div>
            <div class="value">${value}</div>
          </div>
        `;
      }

      const usersRef = firebase.firestore().collection("users");
      usersRef.get().then((snapshot) => {
        const data = snapshot.docs.map((doc) => ({
          id: doc.id,
          ...doc.data(),
        }));

        document.querySelector("#loader").remove();
        
        const attendees = document.querySelector('.attendees');
        data.forEach(({id,email,photo,visitedSections,...rest})=>{
          console.log(photo);
          attendees.innerHTML += `
            <tr class="attendee">
              <td class="section user-section">
                <div class="section-content">
                  <div class="user">
                    <img class="photo" src="${photo ? photo : 'images/anon.webp'}" />
                    <div class="data">
                    ${field("Attendee",`
                      <div><b>ID:</b> ${id}</div>
                      ${email ? `<div><b>E-mail:</b> ${email}</div>` : ''}
                    `)}
                    ${rest.first_checkin_timestamp ? field("First check-in",formatTimestamp(rest.first_checkin_timestamp.seconds)):""}
                    </div>
                  </div>
                </div>
              </td>
              <td class="section flex">
                ${field("Visited sub-events",`
                <div class="sub-events">
                    ${sections.map((section,index)=>{
                      const attended = visitedSections?.find(visitedSection=>visitedSection.section === index+1);
                      if(attended)
                        return `<div class="chip success">
                          <div class="fields inline">
                            ${field("Sub-event",section)}
                            ${field("Attended on",formatTimestamp(attended.timestamp.seconds))}
                            ${attended.rating ? field("Rating",`<div class="rating">${Array.from(Array(5)).map((_,idx)=>createStar(idx<attended.rating ? "gold":undefined)).join("")}</div>`):""}
                          </div>
                        </div>`;
                                   
                      else
                        return `<div class="chip error">
                          <div class="fields inline">
                            ${field("Sub-event",section)}
                            ${field("Attended on","-")}
                          </div>
                        </div>`;
                    }).join("")}
                  </div>
                `)}
              </td>
            </tr>
          `;
        })
      });
    </script>
  </body>
</html>
