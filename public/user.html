<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Welcome to Go Vilnius Eventualizer</title>

    <!-- Begin theme -->
    <link rel="stylesheet" href="./assets/vendor/fonts/boxicons.css" />
    <link rel="stylesheet" href="./assets/vendor/css/core.css" class="template-customizer-core-css" />
    <link rel="stylesheet" href="./assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
    <link rel="stylesheet" href="./assets/css/demo.css" />
    <link rel="stylesheet" href="./css/styles.css" />

    <!-- Helpers -->
    <script src="./assets/vendor/js/helpers.js"></script>
    <script src="./assets/js/config.js"></script>
    

    <!-- Core JS -->
    <script src="./assets/vendor/libs/jquery/jquery.js"></script>
    <script src="./assets/vendor/libs/popper/popper.js"></script>
    <script src="./assets/vendor/js/bootstrap.js"></script>
    <script src="./assets/vendor/js/menu.js"></script>
    <script src="./assets/js/main.js"></script>
    <script src="./assets/js/ui-modals.js"></script>
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <!-- End of theme -->

    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.4/build/global/luxon.min.js"></script>
    <script src="js/rating.js"></script>
    <script src="js/utils.js"></script>

    <script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth__lt.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css" />

    <script type="text/javascript">
      let qsParams = new URLSearchParams(window.location.search);
      let section = parseInt(qsParams.get('section'));

      let redirUrl = new URL(window.location);
      if (redirUrl.pathname.indexOf('.html') > 0) {
        redirUrl.pathname = '/auth.html';
      } else {
        redirUrl.pathname = '/auth';
      }

      const firebaseConfig = {
        apiKey: "AIzaSyBe6QaZqUU5UNK8SdE3QAnQwFv6pXCpldw",
        authDomain: "qrhamsters-app.firebaseapp.com",
        projectId: "qrhamsters-app",
        storageBucket: "qrhamsters-app.appspot.com",
        messagingSenderId: "948754742478",
        appId: "1:948754742478:web:33526dfa79f6414c32e49f"
      };
      var app = firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
    </script>
  </head>
  <body>
    <div class="content-wrapper">
      <div class="container-xxl flex-grow-1 container-p-y">
      <div class="row">
        <div class="card bg-primary bg-gradient">
          <div class="card-body">
            <div class="row text-center">

      <h3 class="card-title text-primary" style="color: white !important">Go Vilnius Eventualizer</h3>
      <p style="display: none">Firebase user id - <span id="user_id"></span></p>
            
            </div>
            <div class="row text-left">

      <div class="row">
        <div class="col-2">
          <img id="photo" />
        </div>
        <div class="col-2">&nbsp;</div>
        <div class="col-8">
          <span id="display_name" style="color: white !important"></span>
          <form class="form-floating">
            <input disabled="disabled" type="email" class="form-control" id="email" value="">
            <label for="email">El. paštas</label>
          </form>
        </div>
      </div>

            </div>
          </div>
        </div>
      </div>
      <div id="ticket-upload">
        <div class="row mt-2">
          <div class="alert alert-secondary">Patekimas į renginį galimas tik įkėlus savo elektroninį bilietą</div>
        </div>  
        <div class="row">
          <div class="col-8">
            <input class="form-control" type="file" id="files" multiple />
          </div>
          <div class="col-3">
            <button id="send" class="btn btn-primary">Upload</button>
          </div>
        </div>
        <div class="row mt-2">
          <progress value="0" max="100" id="progress"></progress>
          <div class="alert alert-primary" id="uploading">Įkelkite bilieto pdf failą</div>
        </div>
      </div>
      <div id="event-info" class="pb-2" style="display: none">
        <div class="row mt-2">
          <div class="alert alert-primary" id="uploading">Sveikiname prisijungus prie renginio</div>
        </div>
        <div class="row mb-2">
          „Hack4Vilnius“ – tai trijų dienų hakatonas, skirtas skatinti inovacijas Vilniaus mieste. Hakatono tikslas – generuoti idėjas, padedančias spręsti sostinės ir čia veikiančių verslų problemas, bei pasiūlyti alternatyvių ir inovatyvių jų sprendimo būdų.  Šiemet, jau penktą kartą ieškosime sprendimų, kurie padėtų paversti Vilnių dar sveikesniu, švaresniu, išmanesniu ir darnų judumą užtikrinančiu miestu.

          <div class="alert alert-info" role="alert">
            Wifi tinklas: <b>HamsterWifi</b><br />
            Slaptažodis: <b>WeCanDoIt</b>
          </div>
        </div>
        <div class="row">
          <div class="card">
            <div class="card-body" style="padding-left: 5px; padding-right: 5px;">
              <h5 class="card-header">Sutikimas dėl jūsų fotografavimo/filmavimo</h5>

              <img src="https://firebasestorage.googleapis.com/v0/b/qrhamsters-app.appspot.com/o/png_download.png?alt=media&token=26561d18-deb7-44ab-85a0-a62cf5ffcc20" />
    
              <form>
                <button class="btn btn-info">Pasirašyti sutikimą el. parašu</button>
              </form>
            </div>
          </div>      
        </div>
      </div>
      <div class="row">
        <div class="card">
          <div class="card-body pb-1 eventSections" style="padding-left: 5px; padding-right: 5px;">
            <h5 class="card-header">Renginio zonos</h5>
            <div id="loader"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Rating modal -->
    <div class="modal fade" id="rateModal" tabindex="-1" style="display: none;" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Įvertinti renginio zoną</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <h6 class="mb-0" id="selectedSection">-</h5>
            <div class="row">
              <div class="col mb-3">
                <label for="rating" class="form-label">Įvertinimas</label>
                <div id="rating"></div>
              </div>
            </div>
            <div>
              <label for="ratingComment" class="form-label">Komentaras</label>
              <textarea class="form-control" id="ratingComment" rows="3" placeholder="Jūsų komentaras..."></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              Uždaryti
            </button>
            <button type="button" class="btn btn-primary saveReview" data-bs-dismiss="modal">Išsaugoti</button>
          </div>
        </div>
      </div>
    </div>
  </div>

    <!-- Toasts -->
    <div class="bs-toast toast toast-placement-ex m-2 fade bg-danger top-0 start-0 hide" role="alert" aria-live="assertive" aria-atomic="true" data-delay="2000">
      <div class="toast-header">
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body">
      
      </div>
    </div>
    <script>
      function showToast(message){
        const toastDiv = $('.toast');
        toastDiv.find(".toast-body").text(message);
        new bootstrap.Toast(toastDiv).show();
      }
    </script>

    <!-- Event sections -->
    <script>
      const sections = [
        "Keynote",
        "Lunch",
        'Workshop "Legal"',
        "Lounge area",
        "Afterparty",
      ];
      let selectedSection = null;
      let selectedRating = 0;
      function setSections(data){
        $('.eventSections').find('#loader').remove()
        if(!data.length) return $('.eventSections').append("<div class=\"alert alert-secondary\">Jūsų aplankytos renginio zonos atsiras čia - galėsite palikti atsiliepimus ir įvertinimą</div>");
        $('.eventSections').append(`
          <div class="table-responsive text-nowrap">
            <table class="table">  
              <thead>
                <tr>
                  <th>Zona</th>
                  <th>Registracijos laikas</th>
                  <th>Įvertinimas</th>
                </tr>
              </thead>
              <tbody class="table-border-bottom-0" />
            </table>
          </div>
        `)
        data.forEach(({section,timestamp,rating})=>{
          $(`<tr>
              <td><i class="fab fa-angular fa-lg text-danger me-3"></i> <strong>${sections[section-1]}</strong></td>
              <td>${formatTimestamp(timestamp.seconds)}</td>
              <td>
                ${rating ? `
                  <div class="stars">
                    ${Array.from(Array(5)).map((_,idx)=>createStar(idx < rating.rating ? "gold" : "grey")).join("")}
                  </div>
                  `
                : `
                  <button type="button" class="btn btn-primary review" data-bs-toggle="modal" data-bs-target="#rateModal">
                    <span class="tf-icons bx bx-star"></span> Įvertinti
                  </button>
                `}
              </td>
          </tr>`).data({section}).appendTo($('.eventSections').find("tbody"))
        })
      }

      $(document).on('click','.review',function(){
        selectedSection = $(this).closest('tr').data('section');
        $('#selectedSection').html(`Pasirinkta zona: ${sections[selectedSection-1]}`)
      })
      $(document).on('click','.saveReview',async function(){
        if(sections[selectedSection-1] === undefined) return showToast("Pasirinkta neteisinga zona.");
        if(selectedRating < 1 || selectedRating > 5) return showToast("Pasirinkite įvertinimą!");
        const comment = $('#ratingComment').val() || null;
        
        if(!userUid) return;
        const existingSections = (await db.collection('users').doc(userUid).get())?.data();
        existingSections.visitedSections.find(section=>section.section === selectedSection).rating = {
          rating:selectedRating,
          comment
        }
        await db.collection('users').doc(userUid).set({
          visitedSections:existingSections.visitedSections
        },{
          merge:true
        })
        location.reload();
       // const usersRef = db.collection('users')
      })
      $(function(){
        $("#rating").rating({
          "emptyStar":"tf-icons bx bx-star",
          "halfStar":"tf-icons bx bxs-star-half",
          "filledStar":"tf-icons bx bxs-star",
          "click":e=>{
            selectedRating = e.stars;
          }
        });
      });

    </script>

    <!-- Firebase -->
    <script>
      function showEventInfo()
      {
        $("#ticket-upload").hide();
        $("#event-info").show();
      }

      let userUid = null;
      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          userUid = user.uid;

          document.getElementById('user_id').innerText = userUid;
          $("#photo").attr("src", user.photoURL);
          $("#email").val(user.email);
          $("#display_name").text(user.displayName);

          var visitedSections = [];
          var docRef = db.collection("users").doc(user.uid);
          docRef.get().then((doc) => {
              let setPromise = Promise.resolve();
              if (doc.exists) {
                visitedSections = doc.data().visitedSections || [];
                setSections(visitedSections);
              } else {
                setPromise = db.collection("users").doc(user.uid).set({
                  first_checkin_timestamp: new firebase.firestore.Timestamp((new Date()).getTime() / 1000, 0),
                  photo: user.photoURL,
                  email: user.email,
                  displayName: user.displayName,
                  visitedSections: []
                });
                setSections([]);
              }

              setPromise.then(() => {
                if (section > 0 && section < 6) {
                  db.collection("users").doc(user.uid).get().then((doc) => {
                    let sections = doc.data().visitedSections || [];
                    if (!sections.find((val) => val.section == section)) {
                      db.collection("users").doc(user.uid).update({
                        visitedSections: firebase.firestore.FieldValue.arrayUnion({
                          section,
                          timestamp: new firebase.firestore.Timestamp((new Date()).getTime() / 1000, 0)
                        })
                      });
                    }
                  }).catch((error) => {
                    alert(error);
                    window.location.href = redirUrl;
                  });
              }
            }).catch((error) => {
              alert(error);
              window.location.href = redirUrl;
            });
          }).catch((error) => {
            alert(error);
            window.location.href = redirUrl;
          });

        } else {
          alert(error);
          window.location.href = redirUrl;
        }
      });
    </script>

    <!-- Upload -->
    <script>
      var files = [];
      document.getElementById("files").addEventListener("change", function(e) {
        files = e.target.files;
      });
      
      document.getElementById("send").addEventListener("click", function() {
        // Checks if files are selected
        if (files.length != 0) {
          // Loops through all the selected files
          for (let i = 0; i < 1 /* files.length */; i++) {
            // Create a storage reference
            var storage = firebase.storage().ref(`/users/${document.getElementById('user_id').innerText}/pdf/${(new Date()).getTime()}`);
      
            // Upload file
            var upload = storage.put(files[i]);
      
            // Update progress bar
            upload.on(
              "state_changed",
              function progress(snapshot) {
                var percentage =
                  (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                document.getElementById("progress").value = percentage;
              },
      
              function error() {
                alert("Error uploading file");
              },
      
              function complete() {
                document.getElementById(
                  "uploading"
                ).innerText = `Failas ${files[i].name} įkeltas`;

                window.showEventInfo();
              }
            );
          }
        } else {
          alert("No file chosen");
        }
      });
      
      function getFileUrl(filename) {
        // Create a storage reference
        var storage = firebase.storage().ref(filename);
      
        // Get file url
        storage
          .getDownloadURL()
          .then(function(url) {
            console.log(url);
          })
          .catch(function(error) {
            alert("Upload error encountered");
          });
      }
    </script>
  </body>
</html>
