<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Welcome to Go Vilnius Eventualizer</title>

    <!-- Begin theme -->
    <link rel="stylesheet" href="./assets/vendor/fonts/boxicons.css" />
    <link rel="stylesheet" href="./assets/vendor/css/core.css" class="template-customizer-core-css" />
    <link rel="stylesheet" href="./assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
    <link rel="stylesheet" href="./assets/css/demo.css" />

    <!-- Helpers -->
    <script src="./assets/vendor/js/helpers.js"></script>
    <script src="./assets/js/config.js"></script>

    <!-- Core JS -->
    <script src="./assets/vendor/libs/jquery/jquery.js"></script>
    <script src="./assets/vendor/libs/popper/popper.js"></script>
    <script src="./assets/vendor/js/bootstrap.js"></script>
    <script src="./assets/vendor/js/menu.js"></script>
    <script src="./assets/js/main.js"></script>
    <script src="./assets/js/ui-modals.js"></script>
    <script async defer src="https://buttons.github.io/buttons.js"></script>

    <!-- end of theme -->

    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>

    <script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth__lt.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css" />

    <script type="text/javascript">
      const firebaseConfig = {
        apiKey: "AIzaSyBe6QaZqUU5UNK8SdE3QAnQwFv6pXCpldw",
        authDomain: "qrhamsters-app.firebaseapp.com",
        projectId: "qrhamsters-app",
        storageBucket: "qrhamsters-app.appspot.com",
        messagingSenderId: "948754742478",
        appId: "1:948754742478:web:33526dfa79f6414c32e49f"
      };
      var app = firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
    </script>
  </head>
  <body>
    <div id="message">
      <h2>Sveiki atvyke!</h2>
      <h1>Go Vilnius Eventualizer</h1>
      
      <p>Firebase user id - <span id="user_id"></span></p>

      <div>
        Upload Files<br />
        <input type="file" id="files" multiple /><br /><br />
        <button id="send">Upload</button>
        <p id="uploading"></p>
        <progress value="0" max="100" id="progress"></progress>
      </div>
    </div>

    <!-- Button trigger modal -->
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#basicModal">
      Launch modal
    </button>

    <!-- Modal -->
    <div class="modal fade" id="basicModal" tabindex="-1" style="display: none;" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel1">Modal title</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col mb-3">
                <label for="nameBasic" class="form-label">Name</label>
                <input type="text" id="nameBasic" class="form-control" placeholder="Enter Name">
              </div>
            </div>
            <div class="row g-2">
              <div class="col mb-0">
                <label for="emailBasic" class="form-label">Email</label>
                <input type="text" id="emailBasic" class="form-control" placeholder="xxxx@xxx.xx">
              </div>
              <div class="col mb-0">
                <label for="dobBasic" class="form-label">DOB</label>
                <input type="text" id="dobBasic" class="form-control" placeholder="DD / MM / YY">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              Close
            </button>
            <button type="button" class="btn btn-primary">Save changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase -->
    <script>
      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          // User logged in already or has just logged in.
          document.getElementById('user_id').innerText = user.uid;

          var docRef = db.collection("users").doc(user.uid);
          docRef.get().then((doc) => {
              if (doc.exists) {
                  console.log("Document data:", doc.data());
              } else {
                db.collection("users").doc(user.uid).set({
                  first_checkin_timestamp: new firebase.firestore.Timestamp((new Date()).getTime() / 1000, 0),
                  photo: null,
                  visitedSections: []
                });
              }
          }).catch((error) => {
              console.log("Error getting document:", error);
          });
        } else {
          window.location.href = '/index.html';
        }
      });
    </script>

    <!-- Upload -->
    <script>
      var files = [];
      document.getElementById("files").addEventListener("change", function(e) {
        files = e.target.files;
        for (let i = 0; i < files.length; i++) {
          console.log(files[i]);
        }
      });
      
      document.getElementById("send").addEventListener("click", function() {
        // Checks if files are selected
        if (files.length != 0) {
          // Loops through all the selected files
          for (let i = 0; i < 1 /* files.length */; i++) {
            // Create a storage reference
            var storage = firebase.storage().ref(`/users/${document.getElementById('user_id').innerText}/pdf/${(new Date()).getTime()}`);
      
            // Upload file
            var upload = storage.put(files[i]);
      
            // Update progress bar
            upload.on(
              "state_changed",
              function progress(snapshot) {
                var percentage =
                  (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                document.getElementById("progress").value = percentage;
              },
      
              function error() {
                alert("Error uploading file");
              },
      
              function complete() {
                document.getElementById(
                  "uploading"
                ).innerHTML += `${files[i].name} upoaded <br />`;
              }
            );
          }
        } else {
          alert("No file chosen");
        }
      });
      
      function getFileUrl(filename) {
        // Create a storage reference
        var storage = firebase.storage().ref(filename);
      
        // Get file url
        storage
          .getDownloadURL()
          .then(function(url) {
            console.log(url);
          })
          .catch(function(error) {
            alert("Upload error encountered");
          });
      }
    </script>
  </body>
</html>
